name: Track Contributions

on:
  pull_request_review:
    types: [submitted]
  issues:
    types: [closed]
  pull_request:
    types: [closed]
  schedule:
    # Run daily at midnight
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  track-stats:
    name: Track Contribution Stats
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get PR Review Count
        id: pr-reviews
        run: |
          REVIEWS=$(gh api graphql -f query='
            query {
              user(login: "${{ github.repository_owner }}") {
                contributionsCollection {
                  totalPullRequestReviewContributions
                }
              }
            }
          ' --jq '.data.user.contributionsCollection.totalPullRequestReviewContributions')
          echo "count=$REVIEWS" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get Issues Closed Count
        id: issues-closed
        run: |
          ISSUES=$(gh api graphql -f query='
            query {
              user(login: "${{ github.repository_owner }}") {
                contributionsCollection {
                  totalIssueContributions
                }
              }
            }
          ' --jq '.data.user.contributionsCollection.totalIssueContributions')
          echo "count=$ISSUES" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get PR Count
        id: prs
        run: |
          PRS=$(gh api graphql -f query='
            query {
              user(login: "${{ github.repository_owner }}") {
                contributionsCollection {
                  totalPullRequestContributions
                }
              }
            }
          ' --jq '.data.user.contributionsCollection.totalPullRequestContributions')
          echo "count=$PRS" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Stats Badge
        run: |
          mkdir -p .github/badges
          echo "![Code Reviews](${{ steps.pr-reviews.outputs.count }})" > .github/badges/reviews.md
          echo "![Issues Closed](${{ steps.issues-closed.outputs.count }})" > .github/badges/issues.md
          echo "![Pull Requests](${{ steps.prs.outputs.count }})" > .github/badges/prs.md

      - name: Display Stats
        run: |
          echo "ðŸ“Š Contribution Statistics"
          echo "=========================="
          echo "Code Reviews: ${{ steps.pr-reviews.outputs.count }}"
          echo "Issues Closed: ${{ steps.issues-closed.outputs.count }}"
          echo "Pull Requests: ${{ steps.prs.outputs.count }}"

      - name: Comment on PR (if triggered by PR review)
        if: github.event_name == 'pull_request_review'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ðŸŽ‰ Thank you for the code review! Your contribution helps improve code quality.'
            })

      - name: Label Issue (if triggered by issue close)
        if: github.event_name == 'issues' && github.event.action == 'closed'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['resolved']
            })
